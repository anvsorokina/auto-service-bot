{% extends "base.html" %}

{% block title %}Аналитика{% endblock %}
{% block page_title %}Аналитика{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Заявки сегодня</div>
        <div class="stat-value">{{ leads_today }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Записей сегодня</div>
        <div class="stat-value">{{ appointments_today }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Необработанные</div>
        <div class="stat-value" style="color: var(--warning);">{{ leads_new }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Конверсия</div>
        <div class="stat-value">{{ '%.0f' % conversion }}%</div>
    </div>
</div>

<!-- Monthly stats -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
    <div class="detail-card">
        <h3>За этот месяц</h3>
        <div class="detail-row">
            <span class="detail-label">Заявки</span>
            <span class="detail-value"><strong>{{ leads_this_month }}</strong></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Всего за всё время</span>
            <span class="detail-value">{{ leads_total }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Закрыто успешно</span>
            <span class="detail-value" style="color: var(--success);">{{ leads_won }}</span>
        </div>
    </div>

    <div class="detail-card">
        <h3>Использование бота</h3>
        <div class="detail-row">
            <span class="detail-label">Диалогов за месяц</span>
            <span class="detail-value"><strong>{{ conversations_month }}</strong></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Токенов использовано</span>
            <span class="detail-value">{{ '{:,.0f}'.format(tokens_month) }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Расход (примерно)</span>
            <span class="detail-value">~{{ '%.0f' % estimated_cost_rub }} ₽</span>
        </div>
    </div>
</div>

<!-- Status breakdown -->
<div class="detail-card">
    <h3>Воронка заявок</h3>
    {% set total = leads_total if leads_total > 0 else 1 %}
    <div style="display: flex; gap: 0.4rem; margin-top: 1rem; height: 40px; border-radius: 12px; overflow: hidden;">
        {% if status_counts.get('new', 0) + status_counts.get('viewed', 0) > 0 %}
        <div style="flex: {{ status_counts.get('new', 0) + status_counts.get('viewed', 0) }}; background: var(--info-bg); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: var(--info);">
            Новые: {{ status_counts.get('new', 0) + status_counts.get('viewed', 0) }}
        </div>
        {% endif %}
        {% if status_counts.get('contacted', 0) > 0 %}
        <div style="flex: {{ status_counts.get('contacted', 0) }}; background: rgba(167,139,250,0.15); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #a78bfa;">
            Связались: {{ status_counts.get('contacted', 0) }}
        </div>
        {% endif %}
        {% if status_counts.get('won', 0) > 0 %}
        <div style="flex: {{ status_counts.get('won', 0) }}; background: var(--success-bg); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: var(--success);">
            Закрыто: {{ status_counts.get('won', 0) }}
        </div>
        {% endif %}
        {% if status_counts.get('lost', 0) > 0 %}
        <div style="flex: {{ status_counts.get('lost', 0) }}; background: var(--danger-bg); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: var(--danger);">
            Потеряно: {{ status_counts.get('lost', 0) }}
        </div>
        {% endif %}
    </div>

    {% if leads_total == 0 %}
    <div class="empty-state" style="padding: 1rem;">
        <p>Статистика появится, когда начнут приходить заявки.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
