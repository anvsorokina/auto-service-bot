{% extends "base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Äî {{ lead.customer_name or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}{% endblock %}
{% block page_title %}
    <a href="/admin/leads">&larr; –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
    <!-- Left column: Lead info -->
    <div>
        <div class="detail-card">
            <h3>üë§ –ö–ª–∏–µ–Ω—Ç</h3>
            <div class="detail-row">
                <span class="detail-label">–ò–º—è</span>
                <span class="detail-value">{{ lead.customer_name or '‚Äî' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                <span class="detail-value">
                    {% if lead.customer_phone %}
                    <a href="tel:{{ lead.customer_phone }}">{{ lead.customer_phone }}</a>
                    {% else %}‚Äî{% endif %}
                </span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Telegram</span>
                <span class="detail-value">
                    {% if lead.customer_telegram %}
                    <a href="https://t.me/{{ lead.customer_telegram }}" target="_blank">@{{ lead.customer_telegram }}</a>
                    {% else %}‚Äî{% endif %}
                </span>
            </div>
        </div>

        <div class="detail-card">
            <h3>üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å –∏ –ø—Ä–æ–±–ª–µ–º–∞</h3>
            <div class="detail-row">
                <span class="detail-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                <span class="detail-value">{{ device_category_labels.get(lead.device_category, lead.device_category or '‚Äî') }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</span>
                <span class="detail-value">{{ lead.device_full_name or '‚Äî' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">–ü—Ä–æ–±–ª–µ–º–∞</span>
                <span class="detail-value">{{ lead.problem_summary or '‚Äî' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">–°—Ä–æ—á–Ω–æ—Å—Ç—å</span>
                <span class="detail-value">{{ urgency_labels.get(lead.urgency, lead.urgency or '–û–±—ã—á–Ω–∞—è') }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">–û—Ü–µ–Ω–∫–∞</span>
                <span class="detail-value">
                    {% if lead.estimated_price_min and lead.estimated_price_max %}
                    {{ '{:,.0f}'.format(lead.estimated_price_min|float) }}‚Äì{{ '{:,.0f}'.format(lead.estimated_price_max|float) }} ‚ÇΩ
                    {% else %}
                    –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Status -->
        <div class="detail-card">
            <h3>üìã –°—Ç–∞—Ç—É—Å</h3>
            <div id="status-badge" style="margin-bottom: 1rem;">
                <span class="badge badge-{{ lead.status }}">{{ status_labels.get(lead.status, lead.status) }}</span>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% for key, label in status_labels.items() %}
                {% if key != lead.status %}
                <form hx-patch="/admin/leads/{{ lead.id }}/status"
                      hx-target="#status-badge"
                      hx-swap="innerHTML"
                      style="display: inline;">
                    <input type="hidden" name="new_status" value="{{ key }}">
                    <button type="submit" class="btn btn-sm btn-outline">{{ label }}</button>
                </form>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Notes -->
        <div class="detail-card">
            <h3>üìù –ó–∞–º–µ—Ç–∫–∏ –º–∞—Å—Ç–µ—Ä–∞</h3>
            <div id="notes-result"></div>
            <form hx-patch="/admin/leads/{{ lead.id }}/notes"
                  hx-target="#notes-result"
                  hx-swap="innerHTML">
                <textarea name="master_notes"
                          placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ –∑–∞—è–≤–∫–µ..."
                          style="width: 100%; min-height: 80px; margin-bottom: 0.5rem;">{{ lead.master_notes or '' }}</textarea>
                <button type="submit" class="btn btn-sm btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Right column: Chat history with master chat -->
    <div>
        {% if lead.conversation_id and conversation %}
        <div style="margin-bottom: 1rem;">
            <h3 style="margin: 0 0 0.75rem; font-size: 1rem; color: var(--white);">üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º</h3>
            {% set messages = chat_messages %}
            {% include "chat/panel.html" %}
        </div>
        {% elif chat_messages %}
        <div class="detail-card">
            <h3>üí¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏</h3>
            <div class="chat-history">
                {% for msg in chat_messages %}
                <div class="chat-msg chat-msg-{{ msg.role }}">
                    {{ msg.content }}
                    <div class="chat-msg-time">
                        {{ msg.created_at.strftime('%H:%M') if msg.created_at else '' }}
                        {% if msg.role == 'bot' and msg.step_name %}
                        ¬∑ {{ msg.step_name }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="detail-card">
            <h3>üí¨ –ü–µ—Ä–µ–ø–∏—Å–∫–∞ —Å –±–æ—Ç–æ–º</h3>
            <div class="empty-state">
                <p>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>
            </div>
        </div>
        {% endif %}

        <div class="detail-card">
            <h3>‚ÑπÔ∏è –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</h3>
            <div class="detail-row">
                <span class="detail-label">ID –∑–∞—è–≤–∫–∏</span>
                <span class="detail-value" style="font-family: monospace; font-size: 0.8rem;">{{ lead.id }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">–°–æ–∑–¥–∞–Ω–∞</span>
                <span class="detail-value">{{ lead.created_at.strftime('%d.%m.%Y %H:%M') if lead.created_at else '‚Äî' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</span>
                <span class="detail-value">
                    {% if lead.notification_sent %}
                    ‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {{ lead.notification_sent_at.strftime('%d.%m %H:%M') if lead.notification_sent_at else '' }}
                    {% else %}
                    ‚ùå –ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
</div>
{% endblock %}
