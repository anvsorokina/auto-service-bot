{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block page_title %}‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}

{% block content %}
{% if saved %}
<div class="alert alert-success">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>
{% endif %}

<form action="/admin/settings" method="post">
    <!-- Basic Info -->
    <div class="detail-card">
        <h3>üè™ –û—Å–Ω–æ–≤–Ω—ã–µ</h3>

        <div class="form-group">
            <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞</label>
            <input type="text" name="name" id="name" required value="{{ shop.name }}">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="address">–ê–¥—Ä–µ—Å</label>
                <input type="text" name="address" id="address"
                       placeholder="—É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10"
                       value="{{ shop.address or '' }}">
            </div>
            <div class="form-group">
                <label for="maps_url">–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É</label>
                <input type="url" name="maps_url" id="maps_url"
                       placeholder="https://yandex.ru/maps/..."
                       value="{{ shop.maps_url or '' }}">
            </div>
        </div>
    </div>

    <!-- Bot Settings -->
    <div class="detail-card">
        <h3>ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h3>

        <div class="form-group">
            <label for="greeting_text">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea name="greeting_text" id="greeting_text"
                      placeholder="–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Å —Ä–µ–º–æ–Ω—Ç–æ–º –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è...">{{ shop.greeting_text or '' }}</textarea>
            <small style="color: var(--muted);">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</small>
        </div>

        <div class="form-group">
            <label>–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞</label>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                {% for value, label, desc in personality_options %}
                <label style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 8px; cursor: pointer; flex: 1; min-width: 150px;">
                    <input type="radio" name="bot_personality" value="{{ value }}"
                           {% if (shop.bot_personality or 'friendly') == value %}checked{% endif %}>
                    <div>
                        <strong>{{ label }}</strong>
                        <br><small style="color: var(--muted);">{{ desc }}</small>
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label for="promo_text">–ê–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏</label>
            <textarea name="promo_text" id="promo_text"
                      placeholder="–°–∫–∏–¥–∫–∞ 10% –Ω–∞ –∑–∞–º–µ–Ω—É –º–∞—Å–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞!&#10;–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.">{{ shop.promo_text or '' }}</textarea>
            <small style="color: var(--muted);">–ë–æ—Ç –±—É–¥–µ—Ç —É–ø–æ–º–∏–Ω–∞—Ç—å —ç—Ç–æ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</small>
        </div>

        <div class="form-group">
            <label for="bot_faq_custom">–ö–∞—Å—Ç–æ–º–Ω—ã–µ FAQ</label>
            <textarea name="bot_faq_custom" id="bot_faq_custom" style="min-height: 120px;"
                      placeholder="–í: –ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?&#10;–û: –ú—ã –Ω–∞ —É–ª. –ü—É—à–∫–∏–Ω–∞, 10, –≤—Ö–æ–¥ —Å–æ –¥–≤–æ—Ä–∞.&#10;&#10;–í: –î–µ–ª–∞–µ—Ç–µ –ª–∏ –≤—ã –∫—É–∑–æ–≤–Ω–æ–π —Ä–µ–º–æ–Ω—Ç?&#10;–û: –î–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º –∫—É–∑–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –∏ –ø–æ–∫—Ä–∞—Å–∫—É.">{{ shop.bot_faq_custom or '' }}</textarea>
            <small style="color: var(--muted);">–§–æ—Ä–º–∞—Ç: –í: –≤–æ–ø—Ä–æ—Å / –û: –æ—Ç–≤–µ—Ç. –ë–æ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –æ—Ç–≤–µ—Ç—ã.</small>
        </div>
    </div>

    <!-- Data Collection -->
    <div class="detail-card">
        <h3>üìã –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</h3>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="collect_name" value="true"
                       {% if shop.collect_name %}checked{% endif %}>
                –°–ø—Ä–∞—à–∏–≤–∞—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="collect_phone" value="true"
                       {% if shop.collect_phone %}checked{% endif %}>
                –°–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="offer_appointment" value="true"
                       {% if shop.offer_appointment %}checked{% endif %}>
                –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º
            </label>
        </div>
    </div>

    <!-- Working Hours -->
    <div class="detail-card">
        <h3>üïê –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</h3>
        <div id="working-hours">
            {% for day_key, day_name in days_ru.items() %}
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <span style="width: 120px; font-size: 0.9rem;">{{ day_name }}</span>
                {% set hours = shop.working_hours.get(day_key) if shop.working_hours else None %}
                <label style="display: flex; align-items: center; gap: 0.25rem;">
                    <input type="checkbox" class="day-toggle" data-day="{{ day_key }}"
                           {% if hours %}checked{% endif %}
                           onchange="toggleDay(this)">
                </label>
                <input type="time" class="day-open" data-day="{{ day_key }}"
                       value="{{ hours.open if hours else '09:00' }}"
                       {% if not hours %}disabled{% endif %}
                       style="padding: 0.3rem; font-size: 0.85rem;">
                <span>‚Äî</span>
                <input type="time" class="day-close" data-day="{{ day_key }}"
                       value="{{ hours.close if hours else '19:00' }}"
                       {% if not hours %}disabled{% endif %}
                       style="padding: 0.3rem; font-size: 0.85rem;">
            </div>
            {% endfor %}
        </div>
        <input type="hidden" name="working_hours_json" id="working-hours-json">
    </div>

    <div style="margin-top: 1rem;">
        <button type="submit" class="btn btn-primary" onclick="prepareWorkingHours()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
function toggleDay(checkbox) {
    const day = checkbox.dataset.day;
    const open = document.querySelector(`.day-open[data-day="${day}"]`);
    const close = document.querySelector(`.day-close[data-day="${day}"]`);
    open.disabled = !checkbox.checked;
    close.disabled = !checkbox.checked;
}

function prepareWorkingHours() {
    const hours = {};
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    days.forEach(day => {
        const toggle = document.querySelector(`.day-toggle[data-day="${day}"]`);
        if (toggle && toggle.checked) {
            const open = document.querySelector(`.day-open[data-day="${day}"]`).value;
            const close = document.querySelector(`.day-close[data-day="${day}"]`).value;
            hours[day] = { open: open, close: close };
        } else {
            hours[day] = null;
        }
    });
    document.getElementById('working-hours-json').value = JSON.stringify(hours);
}
</script>
{% endblock %}
