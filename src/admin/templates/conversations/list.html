{% extends "base.html" %}

{% block title %}Клиенты{% endblock %}
{% block page_title %}Клиенты{% endblock %}

{% block content %}

<!-- Mini-funnel bar -->
<div class="funnel-bar">
    <div style="display:inline-block;text-align:center;min-width:100px;">
        <div style="font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;color:var(--white);line-height:1;margin-bottom:0.25rem;">{{ funnel.total_started }}</div>
        <div class="funnel-label">Начали</div>
    </div>
    <div style="font-size:1.4rem;color:var(--gray3);flex-shrink:0;display:inline-block;">&rarr;</div>
    <div style="display:inline-block;text-align:center;min-width:100px;">
        <div style="font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;color:var(--white);line-height:1;margin-bottom:0.25rem;">{{ funnel.reached_problem }}</div>
        <div class="funnel-label">Дошли до проблемы</div>
    </div>
    <div style="font-size:1.4rem;color:var(--gray3);flex-shrink:0;display:inline-block;">&rarr;</div>
    <div style="display:inline-block;text-align:center;min-width:100px;">
        <div style="font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;color:var(--accent);line-height:1;margin-bottom:0.25rem;">{{ funnel.became_lead }}</div>
        <div class="funnel-label">Стали заявкой</div>
    </div>
</div>

<!-- Filters -->
<div class="filters-bar">
    <!-- Warmth filter buttons -->
    <div class="warmth-filter-group">
        <a href="/admin/conversations{% if status_filter %}?status={{ status_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
           class="btn btn-sm {% if not warmth_filter %}btn-primary{% else %}btn-outline{% endif %}">
            Все
        </a>
        <a href="/admin/conversations?warmth=hot{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
           class="btn btn-sm {% if warmth_filter == 'hot' %}btn-danger{% else %}btn-outline{% endif %}"
           style="{% if warmth_filter != 'hot' %}border-color:rgba(248,113,113,0.4);color:var(--danger);{% endif %}">
            Горячие
        </a>
        <a href="/admin/conversations?warmth=warm{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
           class="btn btn-sm {% if warmth_filter == 'warm' %}btn-warning{% else %}btn-outline{% endif %}"
           style="{% if warmth_filter != 'warm' %}border-color:rgba(251,191,36,0.4);color:var(--warning);{% endif %}">
            Тёплые
        </a>
        <a href="/admin/conversations?warmth=cold{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
           class="btn btn-sm {% if warmth_filter == 'cold' %}btn-outline{% else %}btn-outline{% endif %}"
           style="{% if warmth_filter == 'cold' %}background:rgba(255,255,255,0.06);{% endif %}">
            Холодные
        </a>
    </div>

    <!-- Status filter dropdown -->
    <select
        name="status"
        hx-get="/admin/conversations"
        hx-target="#conversations-table"
        hx-push-url="true"
        hx-include="[name='search']"
        style="margin-left: 0.5rem; max-width: 200px;">
        <option value="">Все статусы</option>
        <optgroup label="Заявки">
            {% for key, label in lead_status_labels.items() %}
            <option value="{{ key }}" {% if status_filter == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </optgroup>
        <optgroup label="Диалоги">
            {% for key, label in status_labels.items() %}
            <option value="{{ key }}" {% if status_filter == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </optgroup>
    </select>

    <!-- Search -->
    <input type="search"
           name="search"
           placeholder="Поиск по имени, автомобилю..."
           value="{{ search }}"
           hx-get="/admin/conversations"
           hx-target="#conversations-table"
           hx-trigger="keyup changed delay:300ms"
           hx-include="[name='status']"
           style="margin-left: auto; max-width: 250px;">
</div>

<!-- Table -->
<div id="conversations-table">
    {% include "conversations/partials/table.html" %}
</div>

{% endblock %}
